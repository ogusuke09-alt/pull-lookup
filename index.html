<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pull # Lookup — OCR App</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#0d1117; color:#eee; text-align:center; padding:20px; }
    input, button { margin:6px; padding:10px 12px; font-size:16px; }
    button { background:#2f81f7; color:#fff; border:none; border-radius:8px; }
    button:disabled { opacity:.6; }
    .ok { color:#8ef59a; font-weight:600; }
    .err { color:#ff7b7b; font-size:14px; margin-top:6px; min-height:1.4em; }
    .result { margin-top:20px; font-size:18px; border:1px solid #333; padding:12px; border-radius:8px; }
    hr { border:0; border-top:1px solid #333; margin:18px 0; }
    .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    #editBlock { display:none; margin-top:10px; }
    #preview { max-width:95vw; border:1px dashed #555; border-radius:8px; background:#0b1117; touch-action:none; }
    .hint { color:#9aa3ab; font-size:13px; }
    .statusline { min-height:1.4em; }
  </style>
</head>
<body>
  <h2>Pull # Lookup — OCR App (Full-Res Crop)</h2>

  <p><strong>Step 1:</strong> Load OCR engine.</p>
  <button id="btnInit">Init OCR</button>
  <div id="ocrState" class="statusline">Waiting…</div>
  <div id="err" class="err"></div>

  <hr>

  <p><strong>Step 2:</strong> Upload your CSV or load a sample:</p>
  <input type="file" id="csvFile" accept=".csv"><br>
  <button id="btnSample">Load sample</button>
  <div id="status" class="statusline"></div>

  <hr>

  <p><strong>Step 3:</strong> Enter LDU or use OCR:</p>
  <div class="row">
    <input type="text" id="ldu" placeholder="Enter LDU (last 3)" inputmode="latin" autocapitalize="characters">
    <button id="btnSearch">Search</button>
  </div>
  <div class="row">
    <button id="btnCamera">Scan with Camera</button>
    <button id="btnImage">Choose Image</button>
  </div>

  <!-- Simple editor with crop -->
  <div id="editBlock">
    <p class="hint">Drag on the image to draw a crop box around the postal code, then tap “Run OCR on Crop”.</p>
    <canvas id="preview" width="0" height="0"></canvas><br>
    <div class="row">
      <button id="btnOCRCrop">Run OCR on Crop</button>
      <button id="btnResetCrop">Reset Crop</button>
    </div>
  </div>

  <div id="result" class="result" style="display:none"></div>

  <!-- Engine (local file in the same folder as this HTML) -->
  <script src="tesseract.min.js"></script>
<script>
let data=[], worker=null;

// ========== INIT OCR ==========
async function initOCR(){
  try {
    document.getElementById('err').textContent="";
    document.getElementById('ocrState').textContent="Loading Tesseract…";

    worker = await Tesseract.createWorker("eng", 1, {
      workerPath: "worker.min.js",
      corePath: "core/"   // folder containing tesseract-core.wasm.js
    });

    document.getElementById('ocrState').innerHTML = "<span class='ok'>OCR ready ✅</span>";
  } catch(e){
    document.getElementById('err').textContent = "Init failed: "+e.message;
    document.getElementById('ocrState').textContent="Error ❌";
  }
}
document.getElementById('btnInit').addEventListener('click', initOCR);

// ========== CSV LOAD ==========
document.getElementById('csvFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines = ev.target.result.split(/\r?\n/);
    const headers = lines[0].split(",");
    const depot = headers.indexOf("Depot");
    const route = headers.indexOf("Route");
    const street= headers.indexOf("Street");
    const range = headers.indexOf("Address Range");
    const ldu   = headers.indexOf("LDU");
    const pull  = headers.indexOf("Pull #");
    data = lines.slice(1).map(row=>{
      const c=row.split(",");
      return {Depot:c[depot], Route:c[route], Street:c[street], Range:c[range], LDU:(c[ldu]||"").trim().toUpperCase(), Pull:c[pull]};
    }).filter(x=>x.Depot && x.LDU && x.Pull);
    document.getElementById('status').textContent="CSV loaded ("+data.length+" rows)";
  };
  r.readAsText(f);
});
document.getElementById('btnSample').addEventListener('click', ()=>{
  data=[{Depot:"Whiterock",Route:"LC0008",Street:"16 Ave",Range:"1500-1598",LDU:"1C2",Pull:"7"}];
  document.getElementById('status').textContent="Sample loaded. Try LDU 1C2.";
});

// ========== SEARCH ==========
document.getElementById('btnSearch').addEventListener('click', ()=>{
  const ldu=document.getElementById('ldu').value.trim().toUpperCase();
  const hit=data.find(r=>r.LDU===ldu);
  if(hit){ showResult(hit); } 
  else { document.getElementById('result').style.display="block"; document.getElementById('result').textContent="No match."; }
});
function showResult(r){
  const box=document.getElementById('result'); box.style.display="block";
  box.innerHTML=`${r.Route} • ${r.Street} ${r.Range||''}<br>LDU ${r.LDU}<br><strong>Pull # ${r.Pull}</strong>`;
}

// ========== OCR HELPERS ==========
function rotateCanvas(src, deg){
  const c=document.createElement("canvas"), ctx=c.getContext("2d");
  if(deg%180){ c.width=src.height; c.height=src.width; }
  else { c.width=src.width; c.height=src.height; }
  ctx.translate(c.width/2,c.height/2);
  ctx.rotate(deg*Math.PI/180);
  ctx.drawImage(src,-src.width/2,-src.height/2);
  return c;
}
function preprocessWithThreshold(imgOrCanvas, scale=2, contrast=1.35, threshold=140){
  const c=document.createElement("canvas"), ctx=c.getContext("2d");
  c.width=imgOrCanvas.width*scale; c.height=imgOrCanvas.height*scale;
  ctx.drawImage(imgOrCanvas,0,0,c.width,c.height);
  const id=ctx.getImageData(0,0,c.width,c.height);
  const d=id.data;
  for(let i=0;i<d.length;i+=4){
    let v=0.299*d[i]+0.587*d[i+1]+0.114*d[i+2];
    v=(v-128)*contrast+128;
    const b=(v>=threshold)?255:0;
    d[i]=d[i+1]=d[i+2]=b;
  }
  ctx.putImageData(id,0,0);
  return c;
}
function preprocessForLDU(imgOrCanvas){
  return preprocessWithThreshold(imgOrCanvas,2,1.35,140);
}
const FULL_PC_RE=/[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ][ -]?\d[ABCEGHJKLMNPRSTVWXYZ]\d/;

async function runLDUOCR(imgOrCanvas, worker){
  let tried=[];
  for(const deg of [0,90,180,270]){
    const rot=rotateCanvas(imgOrCanvas,deg);
    const pre=preprocessForLDU(rot);
    const {data:{text}}=await worker.recognize(pre);
    const t=text.toUpperCase();
    tried.push(t);
    const m=t.match(FULL_PC_RE);
    if(m) return m[0].replace(/\s/g,"").slice(-3);
  }
  console.log("Tried OCR texts:",tried);
  return null;
}

// ========== OCR IMAGE ==========
async function recognizeFile(file){
  if(!worker){ document.getElementById('err').textContent="Init OCR first"; return; }
  const img=new Image(); 
  img.onload=async()=>{
    const ldu=await runLDUOCR(img, worker);
    if(!ldu){
      document.getElementById('err').textContent="No postal code found";
      return;
    }
    document.getElementById('ldu').value=ldu;
    document.getElementById('status').textContent="OCR detected LDU: "+ldu;
  };
  img.src=URL.createObjectURL(file);
}
document.getElementById('btnImage').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{ if(e.target.files[0]) recognizeFile(e.target.files[0]); };
  i.click();
});
document.getElementById('btnCamera').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='image/*'; i.capture='environment';
  i.onchange=e=>{ if(e.target.files[0]) recognizeFile(e.target.files[0]); };
  i.click();
});
</script>
</body>
</html>