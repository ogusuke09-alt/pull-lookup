<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pull # Lookup — OCR App (Tuned)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root { color-scheme: dark; }
  body{margin:0;padding:16px;background:#0d1117;color:#e6edf3;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial,sans-serif}
  h1{font-size:24px;margin:0 0 12px}
  .card{border:1px solid #30363d;border-radius:12px;padding:14px;margin:12px auto;max-width:960px;background:#0d1117}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"]{flex:1;min-width:200px;padding:10px 12px;border-radius:10px;border:1px solid #30363d;background:#0b1320;color:#e6edf3;font-size:16px}
  button{background:#2f6feb;border:none;color:#fff;border-radius:12px;padding:10px 14px;font-size:16px}
  button:disabled{opacity:.5}
  .ok{color:#7ee787;font-weight:600}
  .err{color:#ff7b72}
  .muted{color:#8b949e}
  #previewWrap{position:relative;display:inline-block;max-width:100%}
  #preview{display:block;border:1px dashed #3b3f46;border-radius:8px;max-width:100%}
  /* selection rectangle */
  #cropOverlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none}
  .rect{position:absolute;border:3px dashed #58a6ff;border-radius:6px;box-shadow:0 0 0 9999px rgba(0,0,0,.25);pointer-events:none}
  details{margin-top:10px}
  .result{border:1px solid #30363d;border-radius:10px;padding:12px;margin-top:10px}
</style>
<!-- Tesseract core library (global Tesseract) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>Pull # Lookup — OCR App</h1>
    <div id="ocrState" class="muted">Tap “Init OCR” to load the engine.</div>
    <div class="row" style="margin-top:8px">
      <button id="btnInit">Init OCR</button>
      <button id="btnLoadSampleCsv">Load sample CSV</button>
      <label class="row" style="gap:10px;align-items:center;">
        <input type="file" id="csvFile" accept=".csv" />
      </label>
    </div>
    <div id="csvInfo" class="muted" style="margin-top:6px"></div>
    <div id="initErr" class="err" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px">Step 2: Enter LDU or use OCR</h2>
    <div class="row">
      <input id="lduInput" type="text" placeholder="LDU (last 3)" inputmode="latin-prose" maxlength="3" />
      <button id="btnSearch">Search</button>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnCamera">Scan with Camera</button>
      <button id="btnChoose">Choose Image</button>
    </div>

    <p class="muted" style="margin:10px 0 8px">
      Tip: rotate to make the postal code horizontal, draw a crop box around it, then run OCR.
    </p>

    <div id="previewWrap">
      <canvas id="preview"></canvas>
      <div id="cropOverlay"><div id="cropRect" class="rect" style="display:none"></div></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="btnRotateL">↺ Rotate 90° Left</button>
      <button id="btnRotateR">↻ Rotate 90° Right</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnOcr">Run OCR on Crop</button>
      <button id="btnResetCrop">Reset Crop</button>
    </div>

    <div id="ocrMsg" class="muted" style="margin-top:8px"></div>
    <div id="searchResult" class="result" style="display:none"></div>

    <details>
      <summary>Debug</summary>
      <pre id="debug" style="white-space:pre-wrap"></pre>
    </details>
  </div>

<script>
/* ========= Globals ========= */
let worker = null;                // Tesseract worker
let data = [];                    // CSV rows
let imgOrig = null;               // HTMLImageElement of original image
let previewScale = 1;             // scale from original -> preview canvas
let rotation = 0;                 // 0, 90, 180, 270 (degrees)
const preview = document.getElementById('preview');
const ctx = preview.getContext('2d', { willReadFrequently: true });
const cropRectEl = document.getElementById('cropRect');
const debugEl = document.getElementById('debug');

/* ========= Utils ========= */
function log(msg){ debugEl.textContent += msg + "\n"; }
function show(msg, id){ const el=document.getElementById(id); if(el) el.textContent=msg; }
function regexPostal(text){
  // Robust Canadian postal code (no D F I O Q U) and tolerate spaces/newlines
  const re = /([ABCEGHJKLMNPRSTVXY]\s*\d\s*[ABCEGHJKLMNPRSTVWXYZ])\s*(\d\s*[ABCEGHJKLMNPRSTVWXYZ]\s*\d)/gi;
  return re.exec(text);
}
function toLDU(fullPC){
  return fullPC.replace(/\s/g,'').slice(-3).toUpperCase();
}

/* ========= OCR Init (safe for iPhone & GitHub Pages) ========= */
document.getElementById('btnInit').addEventListener('click', initOCR);
async function initOCR(){
  try{
    document.getElementById('initErr').textContent = '';
    if(!window.Tesseract){
      document.getElementById('initErr').textContent = "Tesseract library not loaded — refresh the page.";
      return;
    }
    show("Loading OCR engine…", "ocrState");

    worker = await Tesseract.createWorker("eng", 1, {
      // Always pull from CDN; works on GitHub Pages and iOS
      workerPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",
      corePath:   "https://cdn.jsdelivr.net/npm/tesseract.js-core@5/dist/tesseract-core.wasm.js"
    });

    show("OCR ready ✅", "ocrState");
  }catch(e){
    show("Init failed: " + (e?.message || e), "initErr");
    show("Error ❌","ocrState");
  }
}

/* ========= CSV handling ========= */
document.getElementById('btnLoadSampleCsv').addEventListener('click', ()=>{
  data = [{Depot:"Whiterock",Route:"LC0008",Street:"16 Ave",Range:"1500-1598",LDU:"1C2",Pull:"7"}];
  show("Sample loaded (1 row). Try LDU 1C2.","csvInfo");
});
document.getElementById('csvFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines = ev.target.result.split(/\r?\n/).filter(Boolean);
    const headers = lines[0].split(",");
    const idx = {
      Depot: headers.indexOf("Depot"),
      Route: headers.indexOf("Route"),
      Street: headers.indexOf("Street"),
      Range: headers.indexOf("Address Range"),
      LDU:   headers.indexOf("LDU"),
      Pull:  headers.indexOf("Pull #")
    };
    data = lines.slice(1).map(row=>{
      const c=row.split(",");
      return {
        Depot: c[idx.Depot],
        Route: c[idx.Route],
        Street:c[idx.Street],
        Range: c[idx.Range],
        LDU:   (c[idx.LDU]||"").trim().toUpperCase(),
        Pull:  c[idx.Pull]
      };
    }).filter(x=>x.Depot && x.LDU && x.Pull);
    show(`CSV loaded (${data.length} rows)`, "csvInfo");
  };
  r.readAsText(f);
});

/* ========= Search by LDU ========= */
document.getElementById('btnSearch').addEventListener('click', ()=>{
  const ldu = document.getElementById('lduInput').value.trim().toUpperCase();
  const hit = data.find(r=>r.LDU===ldu);
  const box = document.getElementById('searchResult');
  if(hit){
    box.style.display = "block";
    box.innerHTML = `${hit.Route} • ${hit.Street} ${hit.Range||''}<br>LDU ${hit.LDU}<br><strong>Pull # ${hit.Pull}</strong>`;
  }else{
    box.style.display = "block";
    box.textContent = "No match.";
  }
});

/* ========= Image load, rotate, scaling ========= */
document.getElementById('btnChoose').addEventListener('click', ()=> pickImage(false));
document.getElementById('btnCamera').addEventListener('click', ()=> pickImage(true));

function pickImage(useCamera){
  const inp = document.createElement('input');
  inp.type='file'; inp.accept='image/*';
  if(useCamera) inp.capture='environment';
  inp.onchange = e => { if(e.target.files[0]) loadImageFile(e.target.files[0]); };
  inp.click();
}

function fitCanvas(image){
  // compute scale so the image fits nicely
  const maxW = Math.min(960, window.innerWidth*0.92);
  const maxH = Math.max(320, window.innerHeight*0.45);

  // if rotated by 90/270, swap logical width/height for scaling
  const r = (rotation % 180) ? { w:image.height, h:image.width } : { w:image.width, h:image.height };
  let scale = Math.min(maxW / r.w, maxH / r.h);
  if(scale > 1) scale = 1;

  // canvas size is the displayed (rotated) size
  preview.width  = Math.round(r.w * scale);
  preview.height = Math.round(r.h * scale);

  // draw with rotation
  ctx.save();
  ctx.clearRect(0,0,preview.width,preview.height);
  if(rotation % 360 === 0){
    ctx.drawImage(image, 0, 0, preview.width, preview.height);
  }else{
    ctx.translate(preview.width/2, preview.height/2);
    ctx.rotate(rotation * Math.PI/180);
    const dw = scale * image.width;
    const dh = scale * image.height;
    ctx.drawImage(image, -dw/2, -dh/2, dw, dh);
  }
  ctx.restore();

  previewScale = scale;
  resetCrop();
}

function loadImageFile(file){
  const img=new Image();
  img.onload = ()=>{ imgOrig = img; rotation = 0; fitCanvas(imgOrig); };
  img.src = URL.createObjectURL(file);
}

document.getElementById('btnRotateL').addEventListener('click', ()=>{ if(imgOrig){ rotation = (rotation+270)%360; fitCanvas(imgOrig); }});
document.getElementById('btnRotateR').addEventListener('click', ()=>{ if(imgOrig){ rotation = (rotation+90)%360;  fitCanvas(imgOrig); }});

/* ========= Crop interaction (mouse + touch) ========= */
let dragStart = null;  // in preview coords
let cropRect = null;   // {x,y,w,h} in preview coords

function resetCrop(){
  cropRect = null;
  cropRectEl.style.display='none';
}

function setRectEl(r){
  cropRectEl.style.left = r.x+"px";
  cropRectEl.style.top  = r.y+"px";
  cropRectEl.style.width= r.w+"px";
  cropRectEl.style.height=r.h+"px";
  cropRectEl.style.display='block';
}

function pointerDown(px,py){
  if(!preview.width) return;
  const rect = preview.getBoundingClientRect();
  const x = px - rect.left, y = py - rect.top;
  dragStart = {x,y};
  cropRect = {x,y,w:0,h:0};
  setRectEl(cropRect);
}
function pointerMove(px,py){
  if(!dragStart) return;
  const rect = preview.getBoundingClientRect();
  let x = px - rect.left, y = py - rect.top;
  // clamp to canvas bounds
  x = Math.max(0, Math.min(preview.width, x));
  y = Math.max(0, Math.min(preview.height, y));
  const x0 = Math.min(dragStart.x, x);
  const y0 = Math.min(dragStart.y, y);
  const w  = Math.abs(x - dragStart.x);
  const h  = Math.abs(y - dragStart.y);
  cropRect = {x:x0,y:y0,w,h};
  setRectEl(cropRect);
}
function pointerUp(){ dragStart = null; }

preview.addEventListener('mousedown', e=>{ pointerDown(e.clientX,e.clientY); });
window.addEventListener('mousemove', e=>{ pointerMove(e.clientX,e.clientY); });
window.addEventListener('mouseup', pointerUp);

// touch
preview.addEventListener('touchstart', e=>{ const t=e.changedTouches[0]; pointerDown(t.clientX,t.clientY); }, {passive:true});
window.addEventListener('touchmove', e=>{ const t=e.changedTouches[0]; pointerMove(t.clientX,t.clientY); }, {passive:true});
window.addEventListener('touchend', pointerUp);

/* ========= Run OCR on crop ========= */
document.getElementById('btnOcr').addEventListener('click', runLduOCR);

async function runLduOCR(){
  try{
    if(!worker){ show("Init OCR first.","ocrMsg"); return; }
    if(!imgOrig){ show("Load or take a picture first.","ocrMsg"); return; }

    // Build an offscreen canvas of the *original* crop (account for rotation & scale)
    const off = document.createElement('canvas');
    const offCtx = off.getContext('2d');
    // If no crop drawn, take center band to increase success
    let r = cropRect;
    if(!r){
      const pad = Math.round(preview.height*0.08);
      r = { x: Math.round(preview.width*0.08), y: pad,
            w: Math.round(preview.width*0.84), h: Math.round(preview.height*0.25) };
    }

    // Map preview rect -> original coordinates (before rotation)
    const sx = r.x / previewScale;
    const sy = r.y / previewScale;
    const sw = r.w / previewScale;
    const sh = r.h / previewScale;

    // After rotation, the preview axes are swapped for 90/270. Map back.
    let sx0, sy0, sw0, sh0, W = imgOrig.width, H = imgOrig.height;
    if(rotation % 360 === 0){
      sx0 = sx; sy0 = sy; sw0 = sw; sh0 = sh;
    } else if(rotation % 360 === 90){
      sx0 = sy;
      sy0 = W - (sx + sw);
      sw0 = sh; sh0 = sw;
    } else if(rotation % 360 === 180){
      sx0 = W - (sx + sw);
      sy0 = H - (sy + sh);
      sw0 = sw; sh0 = sh;
    } else { // 270
      sx0 = H - (sy + sh);
      sy0 = sx;
      sw0 = sh; sh0 = sw;
    }

    // Clamp to image bounds
    sx0 = Math.max(0, Math.min(W-1, sx0));  sy0 = Math.max(0, Math.min(H-1, sy0));
    sw0 = Math.max(1, Math.min(W - sx0, sw0)); sh0 = Math.max(1, Math.min(H - sy0, sh0));

    // Preprocess: upscale, grayscale, light threshold
    const scaleUp = Math.min(2.5, Math.max(1, 600 / Math.min(sw0, sh0)));
    off.width  = Math.round(sw0 * scaleUp);
    off.height = Math.round(sh0 * scaleUp);

    // draw cropped region
    offCtx.imageSmoothingEnabled = true;
    offCtx.imageSmoothingQuality = 'high';
    offCtx.drawImage(imgOrig, sx0, sy0, sw0, sh0, 0, 0, off.width, off.height);

    // grayscale + adaptive threshold
    const imgData = offCtx.getImageData(0,0,off.width,off.height);
    const d = imgData.data;
    for(let i=0;i<d.length;i+=4){
      const g = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114);
      const v = g>160 ? 255 : (g<90 ? 0 : g); // gentle threshold
      d[i]=d[i+1]=d[i+2]=v;
    }
    offCtx.putImageData(imgData,0,0);

    // OCR
    show("Running OCR…","ocrMsg");
    const res = await worker.recognize(off);
    const raw = (res?.data?.text || "").toUpperCase();
    log("OCR raw:\n" + raw);

    const m = regexPostal(raw);
    if(!m){ show("No postal code found — try tighter crop / rotate level / better light.","ocrMsg"); return; }
    const ldu = toLDU(m[0]);
    document.getElementById('lduInput').value = ldu;
    show("OCR detected LDU: " + ldu, "ocrMsg");
  }catch(e){
    show("OCR failed: " + (e?.message||e), "ocrMsg");
  }
}

/* ========= Reset crop button ========= */
document.getElementById('btnResetCrop').addEventListener('click', resetCrop);
</script>
</body>
</html>