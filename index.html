<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pull # Lookup — OCR App</title>
  <style>
    body { font-family: -apple-system, sans-serif; background:#0d1117; color:#eee; text-align:center; padding:20px; }
    input, button { margin:6px; padding:8px; font-size:16px; }
    button { background:#007bff; color:#fff; border:none; border-radius:6px; }
    canvas { max-width:100%; margin-top:10px; border:1px solid #555; }
    .ok { color:#8ef59a; font-weight:bold; }
    .err { color:#ff7b7b; font-size:14px; margin-top:6px; }
    .result { margin-top:20px; font-size:18px; border:1px solid #333; padding:12px; border-radius:8px; }
  </style>
</head>
<body>
  <h2>Pull # Lookup — OCR App</h2>

  <p><strong>Step 1:</strong> Load OCR engine</p>
  <button id="btnInit">Init OCR</button>
  <div id="ocrState">Waiting…</div>
  <div id="err" class="err"></div>

  <hr>

  <p><strong>Step 2:</strong> Upload your CSV or load a sample:</p>
  <input type="file" id="csvFile" accept=".csv"><br>
  <button id="btnSample">Load sample</button>
  <div id="status"></div>

  <p><strong>Step 3:</strong> Enter LDU or use OCR:</p>
  <input type="text" id="ldu" placeholder="Enter LDU (last 3)">
  <button id="btnSearch">Search</button><br>
  <button id="btnCamera">Scan with Camera</button>
  <button id="btnImage">Choose Image</button>

  <p>Tip: rotate to make the postal code horizontal, draw a crop box around it, then run OCR.</p>
  <canvas id="preview" width="400" height="300"></canvas><br>
  <button id="btnRotateL">⟲ Rotate 90° Left</button>
  <button id="btnRotateR">⟳ Rotate 90° Right</button><br>
  <button id="btnRunOCR">Run OCR on Crop</button>
  <button id="btnResetCrop">Reset Crop</button>

  <div id="result" class="result" style="display:none"></div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
let data=[], worker=null;
let img=null, preview=document.getElementById("preview"), ctx=preview.getContext("2d");
let crop={x:0,y:0,w:0,h:0}, drawing=false, rotation=0;

/* ========= OCR Init (safe for iPhone & GitHub Pages) ========= */
const CDN_CHOICES = [
  "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js",
  "https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"
];
async function pickCdn() {
  for (let url of CDN_CHOICES) {
    try { await fetch(url, { method:"HEAD", mode:"no-cors" }); return url; }
    catch(e) { continue; }
  }
  throw new Error("No CDN reachable");
}
async function initOCR(){
  try {
    document.getElementById('err').textContent="";
    document.getElementById('ocrState').textContent="Loading Tesseract…";
    const cdn = await pickCdn();
    console.log("Using OCR from:", cdn);
    worker = await Tesseract.createWorker("eng", 1);
    document.getElementById('ocrState').innerHTML = "<span class='ok'>OCR ready ✅</span>";
  } catch(e){
    document.getElementById('err').textContent = "Init failed: "+e.message;
    document.getElementById('ocrState').textContent="Error ❌";
  }
}
document.getElementById('btnInit').addEventListener('click', initOCR);

/* ========= CSV LOAD ========= */
document.getElementById('csvFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const lines = ev.target.result.split(/\r?\n/);
    const headers = lines[0].split(",");
    const depot = headers.indexOf("Depot");
    const route = headers.indexOf("Route");
    const street= headers.indexOf("Street");
    const range = headers.indexOf("Address Range");
    const ldu   = headers.indexOf("LDU");
    const pull  = headers.indexOf("Pull #");
    data = lines.slice(1).map(row=>{
      const c=row.split(",");
      return {Depot:c[depot], Route:c[route], Street:c[street], Range:c[range], LDU:(c[ldu]||"").trim().toUpperCase(), Pull:c[pull]};
    }).filter(x=>x.Depot && x.LDU && x.Pull);
    document.getElementById('status').textContent="CSV loaded ("+data.length+" rows)";
  };
  r.readAsText(f);
});
document.getElementById('btnSample').addEventListener('click', ()=>{
  data=[{Depot:"Whiterock",Route:"LC0008",Street:"16 Ave",Range:"1500-1598",LDU:"1C2",Pull:"7"}];
  document.getElementById('status').textContent="Sample loaded. Try LDU 1C2.";
});

/* ========= SEARCH ========= */
document.getElementById('btnSearch').addEventListener('click', ()=>{
  const ldu=document.getElementById('ldu').value.trim().toUpperCase();
  const hit=data.find(r=>r.LDU===ldu);
  if(hit){ showResult(hit); } 
  else { document.getElementById('result').style.display="block"; document.getElementById('result').textContent="No match."; }
});
function showResult(r){
  const box=document.getElementById('result'); box.style.display="block";
  box.innerHTML=`${r.Route} • ${r.Street} ${r.Range||''}<br>LDU ${r.LDU}<br><strong>Pull # ${r.Pull}</strong>`;
}

/* ========= IMAGE PREVIEW & CROP ========= */
function fitCanvas(){
  if(!img) return;
  preview.width = img.width;
  preview.height = img.height;
  ctx.save();
  ctx.clearRect(0,0,preview.width,preview.height);
  if(rotation!==0){
    ctx.translate(preview.width/2, preview.height/2);
    ctx.rotate(rotation*Math.PI/180);
    ctx.drawImage(img,-img.width/2,-img.height/2);
  } else {
    ctx.drawImage(img,0,0);
  }
  ctx.restore();
  if(crop.w>0 && crop.h>0){
    ctx.strokeStyle="cyan"; ctx.lineWidth=2;
    ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
  }
}
function loadImage(file){
  img=new Image();
  img.onload=()=>{ rotation=0; crop={x:0,y:0,w:0,h:0}; fitCanvas(); };
  img.src=URL.createObjectURL(file);
}
preview.addEventListener("mousedown",e=>{
  drawing=true; const rect=preview.getBoundingClientRect();
  crop.x=e.clientX-rect.left; crop.y=e.clientY-rect.top; crop.w=0; crop.h=0;
});
preview.addEventListener("mousemove",e=>{
  if(!drawing) return; const rect=preview.getBoundingClientRect();
  crop.w=(e.clientX-rect.left)-crop.x;
  crop.h=(e.clientY-rect.top)-crop.y;
  fitCanvas();
});
preview.addEventListener("mouseup",()=>{ drawing=false; });
document.getElementById("btnRotateL").addEventListener("click",()=>{rotation=(rotation-90)%360;fitCanvas();});
document.getElementById("btnRotateR").addEventListener("click",()=>{rotation=(rotation+90)%360;fitCanvas();});
document.getElementById("btnResetCrop").addEventListener("click",()=>{crop={x:0,y:0,w:0,h:0};fitCanvas();});

/* ========= OCR ON CROP ========= */
async function runLduOCR(){
  if(!worker){ document.getElementById('err').textContent="Init OCR first"; return; }
  if(!img){ document.getElementById('err').textContent="No image loaded"; return; }

  const tmp=document.createElement("canvas"), tctx=tmp.getContext("2d");
  let sx=crop.x, sy=crop.y, sw=crop.w, sh=crop.h;
  if(sw<=0||sh<=0){ sx=0; sy=0; sw=img.width; sh=img.height; }
  tmp.width=Math.abs(sw); tmp.height=Math.abs(sh);
  tctx.drawImage(preview,sx,sy,sw,sh,0,0,Math.abs(sw),Math.abs(sh));

  const ret=await worker.recognize(tmp);
  const text=(ret.data.text||"").toUpperCase();
  console.log("OCR raw:", text);
  const m=text.match(/[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ]\s?\d[ABCEGHJKLMNPRSTVWXYZ]\d/);
  if(!m){ document.getElementById('err').textContent="No postal code found"; return; }
  const ldu=m[0].replace(/\s/g,"").slice(-3);
  document.getElementById('ldu').value=ldu;
  document.getElementById('status').textContent="OCR detected LDU: "+ldu;
}
document.getElementById("btnRunOCR").addEventListener("click", runLduOCR);

/* ========= FILE PICKERS ========= */
document.getElementById('btnImage').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{ if(e.target.files[0]) loadImage(e.target.files[0]); };
  i.click();
});
document.getElementById('btnCamera').addEventListener('click', ()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='image/*'; i.capture='environment';
  i.onchange=e=>{ if(e.target.files[0]) loadImage(e.target.files[0]); };
  i.click();
});
</script>
</body>
</html>