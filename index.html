<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pull # Lookup — OCR App</title>
  <style>
    :root{
      --bg:#0d1117; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#2563eb; --ok:#10b981; --err:#ef4444; --dash:#60a5fa66;
    }
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
         background:var(--bg); color:var(--text);}
    .wrap{max-width:980px; margin:18px auto; padding:12px;}
    .card{background:var(--panel); border-radius:14px; padding:18px; box-shadow:0 1px 0 #0005; margin-bottom:16px;}
    h1{margin:0 0 10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    button{background:var(--accent); color:#fff; border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer}
    input[type="file"]{color:var(--muted)}
    input[type="text"]{background:#0b1220; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:10px 12px; min-width:260px}
    .muted{color:var(--muted)}
    .ok{color:var(--ok); font-weight:700}
    .err{color:var(--err); font-weight:700}
    .status{margin-top:6px}
    /* image / crop */
    .canvas-wrap{position:relative; display:inline-block; max-width:100%}
    canvas{max-width:100%; height:auto; display:block; border-radius:10px; border:1px dashed #334155}
    .crop{
      position:absolute; border:2px dashed var(--dash); pointer-events:none;
      background:transparent; outline:9999px solid #00000040; border-radius:10px;
    }
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .result{border:1px solid #1f2937; padding:12px; border-radius:10px; margin-top:12px}
    details{margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Pull # Lookup — OCR App</h1>
      <div id="ocrState" class="muted">Waiting…</div>
      <div class="row" style="margin-top:8px">
        <button id="btnInit">Init OCR</button>
        <button id="btnSample">Load sample CSV</button>
        <input type="file" id="csvFile" accept=".csv" />
      </div>
      <div id="csvStatus" class="status muted"></div>
      <div id="initStatus" class="status"></div>
    </div>

    <div class="card">
      <h2 style="margin-top:0">Step 2: Enter LDU or use OCR</h2>
      <div class="row">
        <input id="ldu" type="text" placeholder="LDU (last 3)" />
        <button id="btnSearch">Search</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnCamera">Scan with Camera</button>
        <button id="btnImage">Choose Image</button>
      </div>
      <p class="muted" style="margin:10px 0 12px">
        Tip: rotate to make the postal code horizontal, draw a crop box around it, then run OCR.
      </p>

      <div class="canvas-wrap" id="cwrap" style="display:none">
        <canvas id="canvas" width="1" height="1"></canvas>
        <div id="crop" class="crop" hidden></div>
      </div>
      <div class="btnbar" id="imgBtns" style="display:none">
        <button id="rotL">⟲ Rotate 90° Left</button>
        <button id="rotR">⟳ Rotate 90° Right</button>
        <button id="runOcr">Run OCR on Crop</button>
        <button id="resetCrop">Reset Crop</button>
      </div>

      <div id="ocrDetected" class="status"></div>
      <div id="searchResult" class="result" style="display:none"></div>

      <details>
        <summary>Debug</summary>
        <pre id="log" style="white-space:pre-wrap; overflow:auto"></pre>
      </details>
    </div>
  </div>

  <!-- Load the library locally (at repo root) -->
  <script src="tesseract.min.js"></script>

  <script>
  /* ============ Small logger ============ */
  const logEl = document.getElementById('log');
  const log = (...a)=>{ console.log(...a); logEl.textContent += a.join(' ') + '\\n'; };

  /* ============ Globals ============ */
  let data = [];
  let worker = null;
  let imgBitmap = null;
  let imgAngle = 0;          // 0,90,180,270
  let previewScale = 1;      // image pixels → canvas pixels
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { willReadFrequently:true });
  const cropBox = document.getElementById('crop');
  const cwrap = document.getElementById('cwrap');
  const imgBtns = document.getElementById('imgBtns');
  const initStatus = document.getElementById('initStatus');
  const ocrState = document.getElementById('ocrState');
  const ocrDetected = document.getElementById('ocrDetected');

  /* ============ CSV LOAD ============ */
  function csvToRows(txt){
    const lines = txt.trim().split(/\\r?\\n/);
    const headers = lines[0].split(',');
    const idx=(n)=>headers.indexOf(n);
    const depot=idx('Depot'), route=idx('Route'), street=idx('Street'),
          range=idx('Address Range'), ldu=idx('LDU'), pull=idx('Pull #');
    return lines.slice(1).map(r=>{
      const c=r.split(',');
      return {Depot:c[depot], Route:c[route], Street:c[street],
              Range:c[range], LDU:(c[ldu]||'').trim().toUpperCase(), Pull:c[pull]};
    }).filter(x=>x.Depot && x.LDU && x.Pull);
  }

  document.getElementById('csvFile').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      data = csvToRows(ev.target.result);
      document.getElementById('csvStatus').textContent = `CSV loaded (${data.length} rows)`;
    };
    r.readAsText(f);
  });

  document.getElementById('btnSample').addEventListener('click', ()=>{
    data=[{Depot:'Whiterock',Route:'LC0008',Street:'16 Ave',Range:'1500-1598',LDU:'1C2',Pull:'7'}];
    document.getElementById('csvStatus').textContent='Sample loaded (1 row). Try LDU 1C2.';
  });

  /* ============ SEARCH ============ */
  document.getElementById('btnSearch').addEventListener('click', ()=>{
    const v=document.getElementById('ldu').value.trim().toUpperCase();
    const hit=data.find(r=>r.LDU===v);
    const box=document.getElementById('searchResult');
    if(hit){
      box.style.display='block';
      box.innerHTML = `${hit.Route} • ${hit.Street} ${hit.Range||''}<br>LDU ${hit.LDU}<br><strong>Pull # ${hit.Pull}</strong>`;
    }else{
      box.style.display='block';
      box.textContent='No match.';
    }
  });

  /* ============ Robust OCR Init (LOCAL first, fallback) ============ */
  async function pathExists(url){
    try{
      const resp = await fetch(url, {method:'HEAD', cache:'no-store'});
      return resp.ok;
    }catch{ return false; }
  }

  async function initOCR(){
    initStatus.textContent='';
    ocrDetected.textContent='';
    ocrState.textContent='Initializing…';
    try{
      // Preferred local paths (match your repo)
      let workerUrl = 'engine/worker.min.js';
      let coreUrl   = 'engine/tesseract-core-simd-lstm.wasm.js';

      const haveEngine = await pathExists(workerUrl);
      const haveCore   = await pathExists(coreUrl);

      if(!haveEngine){
        // fallback to engine/worker.min.js required; if missing, we can still try CDN
        log('Local engine worker not found, will rely on CDN worker inside tesseract.min.js (if any).');
      }
      if(!haveCore){
        // fallbacks within /core/ (you have all three)
        const cands = [
          'core/tesseract-core-simd-lstm.wasm.js',
          'core/tesseract-core-lstm.wasm.js',
          'core/tesseract-core.wasm.js'
        ];
        for(const c of cands){
          if(await pathExists(c)){ coreUrl = c; break; }
        }
      }

      log('Using core script:', coreUrl, '| worker:', workerUrl);

      // Create worker with explicit paths; Tesseract global is provided by local tesseract.min.js we loaded.
      worker = await Tesseract.createWorker('eng', 1, {
        workerPath: workerUrl,   // ok if 404 — library can still inline a worker; we log failures
        corePath: coreUrl.startsWith('core') ? 'core/' : 'engine/',
        logger: m => { if(m.status) log(m.status, m.progress ?? ''); }
      });

      ocrState.innerHTML = '<span class="ok">OCR ready ✅</span>';
      initStatus.textContent = `OK — core: ${coreUrl}`;
    }catch(e){
      ocrState.innerHTML = '<span class="err">Error ❌</span>';
      initStatus.innerHTML = `<span class="err">Init failed: ${e?.message||e}</span>`;
      log('Init error:', e);
    }
  }
  document.getElementById('btnInit').addEventListener('click', initOCR);

  /* ============ Image load (camera / gallery) ============ */
  async function pickImage(fromCamera=false){
    return new Promise(res=>{
      const i=document.createElement('input');
      i.type='file'; i.accept='image/*';
      if(fromCamera) i.capture='environment';
      i.onchange=()=>res(i.files[0]||null);
      i.click();
    });
  }

  async function loadToCanvas(file){
    const blob = file;
    const bmp = await createImageBitmap(blob, { imageOrientation:'from-image' });
    imgBitmap = bmp;
    imgAngle = 0;
    draw();
    cwrap.style.display='inline-block';
    imgBtns.style.display='flex';
    // Pre-place a sensible crop (center band)
    placeDefaultCrop();
  }

  document.getElementById('btnCamera').addEventListener('click', async ()=>{
    const f = await pickImage(true); if(!f) return;
    await loadToCanvas(f);
  });
  document.getElementById('btnImage').addEventListener('click', async ()=>{
    const f = await pickImage(false); if(!f) return;
    await loadToCanvas(f);
  });

  /* ============ Canvas draw, rotation, scaling ============ */
  function draw(){
    if(!imgBitmap) return;
    // rotate onto canvas
    const ang = imgAngle % 360;
    const radians = ang * Math.PI/180;
    const iw = imgBitmap.width, ih = imgBitmap.height;
    const [cw, ch] = (ang % 180 === 0) ? [iw, ih] : [ih, iw];

    // Fit canvas to viewport width
    const maxW = Math.min(900, document.body.clientWidth - 48);
    const scale = Math.min(1, maxW / cw);
    previewScale = scale;

    canvas.width  = Math.round(cw * scale);
    canvas.height = Math.round(ch * scale);

    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.rotate(radians);
    ctx.drawImage(imgBitmap, -iw*scale/2, -ih*scale/2, iw*scale, ih*scale);
    ctx.restore();
  }

  document.getElementById('rotL').addEventListener('click', ()=>{ imgAngle=(imgAngle+270)%360; draw(); placeDefaultCrop(); });
  document.getElementById('rotR').addEventListener('click', ()=>{ imgAngle=(imgAngle+90)%360; draw(); placeDefaultCrop(); });

  /* ============ Crop box (drag) ============ */
  let dragging=false, startX=0, startY=0;

  function placeDefaultCrop(){
    // middle horizontal band
    const w=canvas.width, h=canvas.height;
    const cw = Math.round(w*0.5), ch=Math.round(h*0.16);
    const cx = Math.round((w-cw)/2), cy=Math.round(h*0.40);
    showCrop(cx,cy,cw,ch);
  }

  function showCrop(x,y,w,h){
    const r = cropBox;
    r.hidden=false;
    r.style.left = x+'px';
    r.style.top  = y+'px';
    r.style.width  = w+'px';
    r.style.height = h+'px';
  }

  canvas.addEventListener('pointerdown', e=>{
    if(!imgBitmap) return;
    dragging=true;
    const rect=canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    showCrop(startX, startY, 1, 1);
  });
  window.addEventListener('pointermove', e=>{
    if(!dragging) return;
    const rect=canvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y=e.clientY - rect.top;
    const w=Math.abs(x-startX), h=Math.abs(y-startY);
    const left = Math.min(x,startX), top=Math.min(y,startY);
    showCrop(left, top, w, h);
  });
  window.addEventListener('pointerup', ()=> dragging=false);

  document.getElementById('resetCrop').addEventListener('click', placeDefaultCrop);

  /* ============ OCR on crop ============ */
  function getCropImageData(){
    if(cropBox.hidden) return null;
    const x = parseInt(cropBox.style.left||'0',10);
    const y = parseInt(cropBox.style.top||'0',10);
    const w = parseInt(cropBox.style.width||'0',10);
    const h = parseInt(cropBox.style.height||'0',10);
    if(w<6 || h<6) return null;

    // Map canvas → source bitmap
    const sx = Math.round(x/previewScale);
    const sy = Math.round(y/previewScale);
    const sw = Math.round(w/previewScale);
    const sh = Math.round(h/previewScale);

    // draw onto temp canvas at 2x for sharper OCR
    const tmp = document.createElement('canvas');
    tmp.width = sw*2; tmp.height = sh*2;
    const tctx = tmp.getContext('2d');
    // draw with rotation into account
    // easier approach: redraw the already-rotated canvas crop scaled x2
    tctx.drawImage(canvas, x, y, w, h, 0, 0, tmp.width, tmp.height);
    return tmp;
  }

  function extractLDUFromText(text){
    const T = (text||'').toUpperCase();
    // Look for Canadian postal codes, then slice LDU
    const m = T.match(/[ABCEGHJKLMNPRSTVXY]\d[ABCEGHJKLMNPRSTVWXYZ]\s?\d[ABCEGHJKLMNPRSTVWXYZ]\d/);
    if(!m) return null;
    return m[0].replace(/\\s/g,'').slice(-3);
  }

  document.getElementById('runOcr').addEventListener('click', async ()=>{
    if(!worker){ initStatus.innerHTML='<span class="err">Init OCR first</span>'; return; }
    const crop = getCropImageData();
    if(!crop){ initStatus.innerHTML='<span class="err">Draw a crop box first</span>'; return; }

    ocrDetected.textContent = 'Running OCR…';
    try{
      const { data: { text } } = await worker.recognize(crop);
      log('OCR text:', text?.slice(0,120) || '(empty)');
      const ldu = extractLDUFromText(text);
      if(ldu){
        document.getElementById('ldu').value = ldu;
        ocrDetected.innerHTML = `<span class="ok">OCR detected LDU: ${ldu}</span>`;
      }else{
        ocrDetected.innerHTML = `<span class="err">No postal code found in crop</span>`;
      }
    }catch(e){
      ocrDetected.innerHTML = `<span class="err">OCR error: ${e?.message||e}</span>`;
      log('OCR error:', e);
    }
  });

  /* ============ Buttons ============ */
  document.getElementById('btnInit').addEventListener('click', ()=>{});
  document.getElementById('btnCamera').addEventListener('click', ()=>{});
  document.getElementById('btnImage').addEventListener('click', ()=>{});
  </script>
</body>
</html>